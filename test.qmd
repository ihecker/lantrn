---
title: "lantrn"
author: "Irwin Hecker"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
#install.packages("tidyr")
library(tidyr)

#install.packages("dplyr")
library(dplyr)

#install.packages("ggplot2")
library(ggplot2)

library(stringr)
#install.packages("roxygen2")

#devtools::create("lantrn")

# install.packages("pak")
# 
# pak::pak("r-lib/devtools")

```

You can add options to executable code like this

```{r}

# Load the dplyr package
library(dplyr)

# Create a sample dataset for mutates : OK
test <- data.frame(
  id = rep(1:5, each = 10),
  snack = rep(c("Apple", "Banana", "Carrots", "Celery", "Cucumber", "Grapes", "Pumpkin seeds", "Sunflower seeds", NA, "Missing"), 5)
) %>%
  mutate(
    category = case_when(
      snack %in% c("Apple", "Banana", "Orange", "Grapes") ~ "Fruit lovers",
      snack %in% c("Carrots", "Cucumber", "Celery", "Bell peppers") ~ "Veggies fans",
      TRUE ~ "Nuts and seeds"
    ),
    id_category = case_when(
      id %in% c(1, 2) ~ "Group 1",
      id %in% c(3, 4) ~ "Group 2",
      TRUE ~ "Other"
    ),
    new_snack_group = case_when(
      snack %in% c("Apple", "Banana", "Orange", "Grapes") & id %in% c(1, 2) ~ "Group 1 fruit lovers",
      snack %in% c("Carrots", "Cucumber", "Celery", "Bell peppers") & id %in% c(3, 4) ~ "Group 2 veggie fans"
    ),
    merge1=ifelse(row_number()<=25,"merge",NA),
    merge2=ifelse(row_number()>25,"merge",NA),
    merge=coalesce(merge1,merge2)
  )


#coalesce
test <- data.frame(
  id = rep(1:5, each = 10),
  snack = rep(c("Apple", "Banana", "Carrots", "Celery", "Cucumber", "Grapes", "Pumpkin seeds", "Sunflower seeds", NA, "Missing"), 5)
) %>%
  mutate(
    category = case_when(
      snack %in% c("Apple", "Banana", "Orange", "Grapes") ~ "Fruit lovers",
      snack %in% c("Carrots", "Cucumber", "Celery", "Bell peppers") ~ "Veggies fans",
      TRUE ~ "Nuts and seeds"
    ),
    id_category = case_when(
      id %in% c(1, 2) ~ "Group 1",
      id %in% c(3, 4) ~ "Group 2",
      TRUE ~ "Other"
    ),
    new_snack_group = case_when(
      snack %in% c("Apple", "Banana", "Orange", "Grapes") & id %in% c(1, 2) ~ "Group 1 fruit lovers",
      snack %in% c("Carrots", "Cucumber", "Celery", "Bell peppers") & id %in% c(3, 4) ~ "Group 2 veggie fans"
    ),
    merge1=ifelse(row_number()<=25,"merge",NA),
    merge2=ifelse(row_number()>25,"merge",NA),
    merge=coalesce(merge1,merge2)
  )

check_rec <- function(df,old_vars,new_vars) {
 
TotalCount = nrow(df)

df <- df %>%
  select(all_of(old_vars),all_of(new_vars))%>% 
  tidyr::pivot_longer(cols = -all_of(new_vars))%>% 
  select(value, name, all_of(new_vars))%>%
  mutate(value=paste0(value,";;",name))%>% 
  make_long(c(value, all_of(new_vars))) %>% 
   mutate(name=as.character(str_extract(node, "(?<=;;)[^;]+$")),
          name=case_when(is.na(name)~x,
                         T~name),
           node=as.character(str_extract(node, "^[^;]+")))

dagg <- df%>%
  dplyr::group_by(node)%>%
  tally()

dagg <- dagg%>%
  dplyr::group_by(node)%>%
  dplyr::mutate(pct = n/TotalCount)

# Step 3
df <- merge(df, dagg, by.x = 'node', by.y = 'node', all.x = TRUE)

plot <- ggplot(df, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(name), label = paste0(node," n=", n, '(',  round(pct* 100,1), '%)' ))) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30",
              position="identity") +
  scale_fill_brewer(palette = "Accent")+
  geom_sankey_label(size = 3) +
  theme_sankey(base_size = 9) +
  labs(x = NULL, fill="Variables") +
  theme(legend.position = "top",
         plot.title = element_text(hjust = .5),
        legend.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_blank())
  
return(plot)
return(df)

}
  
check_rec(test,c("snack","id_category"),"new_snack_group")
```

\
The `echo: false` option disables the printing of code (only output is displayed).
